name: publish

on:
  workflow_dispatch:
  push:
    tags:
      - 'v*'

jobs:
  pack-and-publish:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        project:
          - src/NgIcons.AkarIcons/NgIcons.AkarIcons.csproj
          - src/NgIcons.BootstrapIcons/NgIcons.BootstrapIcons.csproj
          - src/NgIcons.Boxicons/NgIcons.Boxicons.csproj
          - src/NgIcons.CircumIcons/NgIcons.CircumIcons.csproj
          - src/NgIcons.CryptocurrencyIcons/NgIcons.CryptocurrencyIcons.csproj
          - src/NgIcons.CssGg/NgIcons.CssGg.csproj
          - src/NgIcons.Devicon/NgIcons.Devicon.csproj
          - src/NgIcons.Dripicons/NgIcons.Dripicons.csproj
          - src/NgIcons.FeatherIcons/NgIcons.FeatherIcons.csproj
          - src/NgIcons.FlagIcons/NgIcons.FlagIcons.csproj
          - src/NgIcons.FontAwesome/NgIcons.FontAwesome.csproj
          - src/NgIcons.GameIcons/NgIcons.GameIcons.csproj
          - src/NgIcons.Heroicons/NgIcons.Heroicons.csproj
          - src/NgIcons.HugeIcons/NgIcons.HugeIcons.csproj
          - src/NgIcons.Iconoir/NgIcons.Iconoir.csproj
          - src/NgIcons.Iconsax/NgIcons.Iconsax.csproj
          - src/NgIcons.Ionicons/NgIcons.Ionicons.csproj
          - src/NgIcons.JamIcons/NgIcons.JamIcons.csproj
          - src/NgIcons.LetsIcons/NgIcons.LetsIcons.csproj
          - src/NgIcons.Lucide/NgIcons.Lucide.csproj
          - src/NgIcons.MaterialFileIcons/NgIcons.MaterialFileIcons.csproj
          - src/NgIcons.MaterialIcons/NgIcons.MaterialIcons.csproj
          - src/NgIcons.MaterialSymbols/NgIcons.MaterialSymbols.csproj
          - src/NgIcons.Mynaui/NgIcons.Mynaui.csproj
          - src/NgIcons.Octicons/NgIcons.Octicons.csproj
          - src/NgIcons.PhosphorIcons/NgIcons.PhosphorIcons.csproj
          - src/NgIcons.RadixIcons/NgIcons.RadixIcons.csproj
          - src/NgIcons.Remixicon/NgIcons.Remixicon.csproj
          - src/NgIcons.SimpleIcons/NgIcons.SimpleIcons.csproj
          - src/NgIcons.SolarIcons/NgIcons.SolarIcons.csproj
          - src/NgIcons.Svgl/NgIcons.Svgl.csproj
          - src/NgIcons.TablerIcons/NgIcons.TablerIcons.csproj
          - src/NgIcons.TdesignIcons/NgIcons.TdesignIcons.csproj
          - src/NgIcons.Typicons/NgIcons.Typicons.csproj
          - src/NgIcons.UxAspects/NgIcons.UxAspects.csproj

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install npm dependencies
        run: npm install

      - name: Regenerate icon sources
        run: npm run extract-icons

      - name: Restore
        run: dotnet restore ngIcons.for.Blazor.sln

      - name: Pack ${{ matrix.project }}
        run: dotnet pack ${{ matrix.project }} -c Release -o artifacts

      - name: Publish package
        if: github.event_name == 'push'
        env:
          NUGET_API_KEY: ${{ secrets.NUGET_API_KEY }}
          NUGET_SOURCE: ${{ secrets.NUGET_SOURCE || 'https://api.nuget.org/v3/index.json' }}
        run: |
          dotnet nuget push "artifacts/*.nupkg" --source "$NUGET_SOURCE" --api-key "$NUGET_API_KEY" --skip-duplicate

      - name: Get project name
        if: github.event_name != 'push'
        id: project-name
        run: echo "name=$(basename ${{ matrix.project }} .csproj)" >> $GITHUB_OUTPUT

      - name: Upload artifacts
        if: github.event_name != 'push'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.project-name.outputs.name }}
          path: artifacts/*.nupkg
