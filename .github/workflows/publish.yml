name: publish

on:
  workflow_dispatch:
  push:
    tags:
      - 'v*'

jobs:
  pack-and-publish:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        project:
          - src/NgIcons.AkarIcons/NgIcons.AkarIcons.csproj
          - src/NgIcons.BootstrapIcons/NgIcons.BootstrapIcons.csproj
          - src/NgIcons.Boxicons/NgIcons.Boxicons.csproj
          - src/NgIcons.CircumIcons/NgIcons.CircumIcons.csproj
          - src/NgIcons.CryptocurrencyIcons/NgIcons.CryptocurrencyIcons.csproj
          - src/NgIcons.CssGg/NgIcons.CssGg.csproj
          - src/NgIcons.Devicon/NgIcons.Devicon.csproj
          - src/NgIcons.Dripicons/NgIcons.Dripicons.csproj
          - src/NgIcons.FeatherIcons/NgIcons.FeatherIcons.csproj
          - src/NgIcons.FlagIcons/NgIcons.FlagIcons.csproj
          - src/NgIcons.FontAwesome/NgIcons.FontAwesome.csproj
          - src/NgIcons.GameIcons/NgIcons.GameIcons.csproj
          - src/NgIcons.Heroicons/NgIcons.Heroicons.csproj
          - src/NgIcons.HugeIcons/NgIcons.HugeIcons.csproj
          - src/NgIcons.Iconoir/NgIcons.Iconoir.csproj
          - src/NgIcons.Iconsax/NgIcons.Iconsax.csproj
          - src/NgIcons.Ionicons/NgIcons.Ionicons.csproj
          - src/NgIcons.JamIcons/NgIcons.JamIcons.csproj
          - src/NgIcons.LetsIcons/NgIcons.LetsIcons.csproj
          - src/NgIcons.Lucide/NgIcons.Lucide.csproj
          - src/NgIcons.MaterialFileIcons/NgIcons.MaterialFileIcons.csproj
          - src/NgIcons.MaterialIcons/NgIcons.MaterialIcons.csproj
          - src/NgIcons.MaterialSymbols/NgIcons.MaterialSymbols.csproj
          - src/NgIcons.Mynaui/NgIcons.Mynaui.csproj
          - src/NgIcons.Octicons/NgIcons.Octicons.csproj
          - src/NgIcons.PhosphorIcons/NgIcons.PhosphorIcons.csproj
          - src/NgIcons.RadixIcons/NgIcons.RadixIcons.csproj
          - src/NgIcons.Remixicon/NgIcons.Remixicon.csproj
          - src/NgIcons.Schematics/NgIcons.Schematics.csproj
          - src/NgIcons.SimpleIcons/NgIcons.SimpleIcons.csproj
          - src/NgIcons.SolarIcons/NgIcons.SolarIcons.csproj
          - src/NgIcons.Svgl/NgIcons.Svgl.csproj
          - src/NgIcons.TablerIcons/NgIcons.TablerIcons.csproj
          - src/NgIcons.TdesignIcons/NgIcons.TdesignIcons.csproj
          - src/NgIcons.Typicons/NgIcons.Typicons.csproj
          - src/NgIcons.UxAspects/NgIcons.UxAspects.csproj

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install npm dependencies
        run: npm install

      - name: Regenerate icon sources
        run: npm run extract-icons

      - name: Restore
        run: dotnet restore ngIcons.for.Blazor.sln

      - name: Pack ${{ matrix.project }}
        run: dotnet pack ${{ matrix.project }} -c Release -o artifacts

      - name: Publish package
        if: github.event_name == 'push'
        env:
          NUGET_API_KEY: ${{ secrets.NUGET_API_KEY }}
        run: |
          for nupkg in artifacts/*.nupkg; do
            # Extract package ID and version from the .nupkg filename
            filename=$(basename "$nupkg" .nupkg)
            # Package naming: PackageId.Version.nupkg
            package_id=$(echo "$filename" | sed -E 's/\.[0-9]+\.[0-9]+\.[0-9]+.*$//')
            version=$(echo "$filename" | sed -E 's/^.*\.([0-9]+\.[0-9]+\.[0-9]+.*)$/\1/')

            echo "Checking if $package_id version $version exists on NuGet..."

            # Check if the package version already exists on NuGet
            http_status=$(curl -s -o /dev/null -w "%{http_code}" "https://api.nuget.org/v3-flatcontainer/${package_id,,}/index.json")

            if [ "$http_status" = "200" ]; then
              # Package exists, check if this specific version exists
              versions=$(curl -s "https://api.nuget.org/v3-flatcontainer/${package_id,,}/index.json" | jq -r '.versions[]' 2>/dev/null)
              if echo "$versions" | grep -qxF "$version"; then
                echo "Package $package_id version $version already exists on NuGet. Skipping..."
                continue
              fi
            fi

            echo "Publishing $package_id version $version..."
            dotnet nuget push "$nupkg" --source "https://api.nuget.org/v3/index.json" --api-key "$NUGET_API_KEY"
          done

      - name: Upload artifacts
        if: github.event_name != 'push'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.project }}-packages
          path: artifacts/*.nupkg
